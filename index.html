<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>囲碁アプリ（タップ補正＋全部入り）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
      margin: 0;
      background-color: #f4f4f4;
    }
    canvas {
      background-color: #f4d9ae;
      border: 2px solid #000;
      margin-top: 10px;
      touch-action: none;
      max-width: 95vw;
      height: auto;
    }
    button {
      margin: 5px;
      padding: 8px 14px;
      font-size: 16px;
    }
    #recordList {
      max-width: 500px;
      margin: 0 auto;
      text-align: left;
      font-size: 14px;
      padding: 0 1em;
    }
    .dark canvas {
      background-color: #333;
    }
    .dark body {
      background-color: #111;
      color: white;
    }
  </style>
</head>
<body>
  <h1>囲碁盤（自由打ち＋記録＋着手番号）</h1>
  <canvas id="goban" width="600" height="600"></canvas>
  <div>
    <button onclick="undo()">↩ 一手戻す</button>
    <button onclick="resetBoard()">🔄 リセット</button>
    <button onclick="downloadKifu()">💾 棋譜保存</button>
    <button onclick="switchFirst()">🔁 先手交代</button>
    <button onclick="toggleTheme()">🎨 テーマ切替</button>
  </div>
  <p id="moveCount">手数: 0</p>
  <ul id="recordList"></ul>

  <script>
    const canvas = document.getElementById("goban");
    const ctx = canvas.getContext("2d");
    let size = 19;
    let cell = canvas.width / (size + 1);
    let board = Array.from({ length: size }, () => Array(size).fill(0));
    let moveHistory = [];
    let turn = 1; // 1:黒 2:白
    let theme = "light";

    const kanji = ["一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五","十六","十七","十八","十九"];
    const abc = "ABCDEFGHJKLMNOPQRST";

    function drawBoard() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // 座標ラベル
      ctx.font = `${cell * 0.4}px sans-serif`;
      ctx.fillStyle = theme === "light" ? "#000" : "#fff";
      for (let i = 0; i < size; i++) {
        ctx.fillText(abc[i], (i + 1) * cell - cell * 0.15, cell * 0.7);
        ctx.fillText(kanji[i], cell * 0.1, (i + 1) * cell + cell * 0.15);
      }

      // 線
      ctx.strokeStyle = "#000";
      for (let i = 1; i <= size; i++) {
        ctx.beginPath();
        ctx.moveTo(cell, i * cell);
        ctx.lineTo(size * cell, i * cell);
        ctx.moveTo(i * cell, cell);
        ctx.lineTo(i * cell, size * cell);
        ctx.stroke();
      }

      // 石と番号
      for (let i = 0; i < moveHistory.length; i++) {
        const {x, y, color} = moveHistory[i];
        ctx.beginPath();
        ctx.arc((x + 1) * cell, (y + 1) * cell, cell * 0.4, 0, Math.PI * 2);
        ctx.fillStyle = color === 1 ? "black" : "white";
        ctx.fill();
        ctx.stroke();
        // 番号
        ctx.fillStyle = color === 1 ? "white" : "black";
        ctx.font = `${cell * 0.35}px sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(i + 1, (x + 1) * cell, (y + 1) * cell);
      }

      document.getElementById("moveCount").textContent = `手数: ${moveHistory.length}`;
    }

    canvas.addEventListener("click", e => {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = Math.floor((e.clientX - rect.left) * scaleX / cell - 0.5);
      const y = Math.floor((e.clientY - rect.top) * scaleY / cell - 0.5);
      if (x >= 0 && x < size && y >= 0 && y < size && board[y][x] === 0) {
        board[y][x] = turn;
        moveHistory.push({x, y, color: turn});
        addRecord(turn, x, y);
        turn = 3 - turn;
        drawBoard();
      }
    });

    function addRecord(color, x, y) {
      const coord = `${x + 1}の${kanji[y]}`;
      const li = document.createElement("li");
      li.textContent = `${moveHistory.length}. ${color === 1 ? "黒" : "白"}が ${coord} に打ちました`;
      document.getElementById("recordList").appendChild(li);
    }

    function undo() {
      if (moveHistory.length === 0) return;
      const last = moveHistory.pop();
      board[last.y][last.x] = 0;
      turn = last.color;
      const list = document.getElementById("recordList");
      list.removeChild(list.lastChild);
      drawBoard();
    }

    function resetBoard() {
      board = Array.from({ length: size }, () => Array(size).fill(0));
      moveHistory = [];
      turn = 1;
      document.getElementById("recordList").innerHTML = "";
      drawBoard();
    }

    function switchFirst() {
      resetBoard();
      turn = 2; // 次は白から
    }

    function downloadKifu() {
      let txt = "";
      moveHistory.forEach((m, i) => {
        txt += `${i + 1}. ${m.color === 1 ? "黒" : "白"}: ${m.x + 1}の${kanji[m.y]}\n`;
      });
      const blob = new Blob([txt], {type: "text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "kifu.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    function toggleTheme() {
      theme = theme === "light" ? "dark" : "light";
      document.body.classList.toggle("dark");
      drawBoard();
    }

    drawBoard();
  </script>
</body>
</html>